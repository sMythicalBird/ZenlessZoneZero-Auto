name: æ‰“åŒ…å¹¶å‘å¸ƒ ğŸ“¦
run-name: ${{ github.event.inputs.VERSION}}

on:
  workflow_dispatch:
    inputs:
      VERSION:
        description: 'è¯·è¾“å…¥ç‰ˆæœ¬å·'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: ä¸‹è½½ Python 3.10
      run: |
        # æœ€ç®€ç‰ˆ Python 3.10
        Start-BitsTransfer "https://www.python.org/ftp/python/3.10.11/python-3.10.11-embed-amd64.zip"
        Start-BitsTransfer "https://bootstrap.pypa.io/get-pip.py"
        Start-BitsTransfer "https://aka.ms/vs/17/release/vc_redist.x64.exe" "(DLL)åˆå§‹åŒ–ä¾‹ç¨‹å¤±è´¥æ—¶-ç‚¹æˆ‘.exe"
        7z e python-3.10.11-embed-amd64.zip -opy310\
        # ä½¿ pip å¯å®‰è£…
        (Get-Content ".\py310\python310._pth") -replace '#import site', 'import site' | Set-Content ".\py310\python310._pth"
        .\py310\python.exe get-pip.py
        Remove-Item python-3.10.11-embed-amd64.zip
        Remove-Item get-pip.py
    
    - name: å®‰è£…CPUä¾èµ–
      run: |
        .\py310\python.exe -m pip install -r requirements-cpu.txt

    - name: é¢„ä¸‹è½½æ¨¡å‹
      run: |
        # ä¸‹è½½æ¨¡å‹ï¼Œæ›´æ–°å½“å‰ç‰ˆæœ¬å·
        .\py310\python.exe release_prepare.py

    - name: æ‰“åŒ…
      run: |
        # 7zå‹ç¼©
        Start-BitsTransfer "http://pan.caiyun.fun/1655577/zzz/start.exe"
        # é˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
        Remove-Item .git\ -Force -Recurse
        7z a -tzip zzzAuto-Onekey.zip ..
    
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ github.event.inputs.VERSION}} CPUä¸€é”®åŒ…
        # tag_name: ${{ github.event.inputs.VERSION}}
        body: "ä½¿ç”¨å‰åŠ¡å¿…é˜…è¯»READMEï¼ï¼å›½å†…[ä¸‹è½½é“¾æ¥](https://pan.quark.cn/s/b33eaf2ffcfc)"
        # ç”Ÿæˆè‰ç¨¿ï¼Œä¸ä¼šç›´æ¥å‘å¸ƒ
        draft: true
        # å¦‚æœæ²¡æœ‰ç›®æ ‡æ–‡ä»¶ï¼Œåˆ™å¤±è´¥åœæ­¢å‘å¸ƒ
        fail_on_unmatched_files: true
        files: |
          zzzAuto-Onekey.zip
